---
title: "Sample Points & Office Rejections"
author: "steppe"
date: '2022-04-27'
output: html_document
---

The purpose of this script is to assist a crew lead in searching for office rejections in the pre-season. It will use a simple set of common spatial data products (e.g. a Digital Elevation Model, BLM Land Ownership, and Roads) to flag points for an office rejection. It is my (many to most persons) firm belief that all points should be investigated regardless after running this script using Google Earth or other 3D rendering engine. We hope that this script:

1) Reduces the time required to import a KML dataset (of AIM points by statum and position in the sample design) to Google Earth.
2) Allows you to readily create and import BLM ownership vector data as KML to Google Earth.
3) Reduces uncertainty in confirming office rejections with the computed metrics which are then verified in Google Earth by you - the analyst. 

# Background Data Handling

```{r Load Libraries, echo = F, warning = F, message = F}
library(tidyverse)
library(readxl)
library(here)
library(sf)
library(terra)
library(leaflet)
library(maptools)
source(here::here('scripts/functions.R'))
```

### Create a copy of your tracking sheet. 

My advice is to to create a MASTER version of all points, and then copy this to a COPY of all points
```{r Copy AIM Sample Design Sheet}

Plot_Tracking_2022 <- read_excel(paste0(here(),  '/data/raw/PlotTracking_AIM_plots_2022-COPY.xlsx'), 
                           sheet = 1, skip = 1) %>% 
  janitor::clean_names()

Proportions <- read_excel(paste0(here(),  '/data/raw/PlotTracking_AIM_plots_2022-COPY.xlsx'), 
                           sheet = 2, skip = 1) %>% 
  janitor::clean_names() %>% 
  drop_na(design_strata, plots)

initial_process <- read_excel(paste0(here(),  '/data/raw/PlotTracking_AIM_plots_2022-COPY.xlsx'), 
                           sheet = 3) %>% 
  janitor::clean_names() 

```

### Slope Rejections

AIM points are to be rejected if they fall upon a slope of 50% or greater. A 50% slope is 26.57 degrees. This value is somewhat notoriously hard to calculate with a DEM, but we had near perfect concordance between our method and an expert analyst (actually we caught 2 more missed rejections via this).

```{r Office Reject Slopes which are too great to Sample}

slope_degree <- raster(paste0(here(), '/data/processed/UFO_slope_deg.tif'))
dem <- raster(paste0(here(), '/data/processed/UFO_dem_10_smooth.tif'))

initial_process <- initial_process %>% 
  drop_na(long:lat) %>% 
  filter(long != 'SAMPLED IN 2018') %>% 
  st_as_sf(coords = c(x = 'long', y = 'lat'), crs = 4269, remove = F) 

ouput <- plot_mover(initial_process, utm_nad = 26913,
                    ras_dem = dem, ras_slo = slope_degree)

ouput <- ouput %>% 
  mutate(across(.cols = long:lat, as.numeric))
```


### Elevation of points 

The lower the land the hotter the site. Sample these and work up.
```{r}

outro <- ouput %>% 
  mutate(Elevation = extract(dem, .))

sort(outro)
```


```{r}
twop <- ouput %>% 
  filter(next_in_line_or_oversample == 'Yes',
         str_detect(plot_id, 'SS|SD'))

leaflet(data = twop) %>%
 addTiles() %>%
 addMarkers(~long, ~lat,
            popup = ~as.character(plot_id),
            label = ~as.character(plot_id))
```

### Create Google Earth Icons for exporting Sites. 

```{r Save AIM Points as Icons}
base_url <- 'http:// google.com/mapfiles/ms/micons/'
url_suffix <- '.png'

opts_base <- paste0(base_url, c('yellow', 'blue', 'green', 'lightblue', 
               'orange', 'pink', 'purple', 'red'), url_suffix)

opts_oversamples <- paste0(base_url, 
                           c('yellow-dot', 'blue-dot', 'green-dot', 'ltblue-dot', 
                             'orange-dot', 'pink-dot', 'purple-dot', 'red-dot'),
                           url_suffix)

rm(base_url, url_suffix)
```

```{r Save BLM Ownership as KML}

kmlfile <- paste(td, "BLM_UFO_Ownership.kml", sep="/")

public_lands_colours <- c(
  
  # these manually transcribed from the H-1553-Publications Standards Manual
  # Handbook - hopefully no errors
  
  blm <- rgb(254, 230, 121),
  blm_wilderness <- rgb(254, 230, 191),
  usfs <- rgb(204, 235, 197),
  usfs_oc <- rgb(179, 222, 105),
  usfs_wilderness <- rgb(153, 213, 148),
  nps <- rgb(202, 189, 220),
  nps_wilderness <- rgb(177, 137, 193),
  usfws_nwr <- rgb(127, 204, 167),
  usfws_wilderness <- rgb(102, 191, 127),
  ntnl_grassland <- rgb(230, 245, 177),
  bureau_reclamation <- rgb(255, 255, 179),
  indian_res <- rgb(253, 180, 108),
  indian_res_wilderness <- rgb(253, 154, 82),
  military_reserve_ACE <- rgb(251, 180, 206),
  federal_other <- rgb(228, 196, 159),
  state <- rgb(179, 227, 238),
  state_wilderness <- rgb(107, 207, 226),
  bankhead-jones <- rgb(252, 205, 207),
  state_county_city_wildlife_parks_etc <- rgb(143, 181, 190),
  private <- rgb(255, 255, 255)

)



kmlPolygons(blm_ownership, kmlfile = kmlfile,
  name = "KML Polygons subset", 
  description = "three countries", 
  col = "blue",
  visibility = 1, lwd = 1, border = "white", kmlname = "R Test 2",
  kmldescription = "This is <b>only</b> a <a href='http://www.r-project.org'>R</a> test.")
## combine to make a list of polygon objects to plot
polList <- c(regions,wrld_simpl)
kmlfile <- paste(td, "worldPoliticalandSubset.kml", sep="/")
```


